# d2912r0: Concurrent queues and sender/receivers

This paper explores extending an interface of Buffered Queue (https://wg21.link/p1958r0) with async APIs
conforming to Sender/Receiver model according to https://wg21.link/p2300. It also mades stylistic API
changes to be more consistent with existent library facilities.

Additionally, we report on implementation experience (https://github/GorNishanov/conqueue)
addressing the concern that supporting
both synchronous and asynchronous push/pop in the same queue is a challenge (https://wg21.link/p2882r0).
The answer based on the implementation is that is no challenge at all.

## Changes to buffer_queue.

By following an example of `std::future`, enum `queue_op_status` was renamed to `conqueue_errc` and we
introduced an exception `conqueue_error` that will be thrown to carry the `conqueue_errc`.

```c++
enum class conqueue_errc { success = 0, empty, full, closed };
class conqueue_error : runtime_exception { ... };
```

The member functions `wait_pop` and `wait_push` were used as non-throwing versions of a blocking `pop` and `push`. By analogy with how
`<filesystem>` deals with this case, we restyled them as follows:

```c++
T pop(); // used to be pop_value
std::optional<T> pop(std::error_code &ec); // used to be wait_pop
std::optional<T> try_pop(std::error_code &ec);
```

```c++
void push(const T& x);
bool push(const T& x, error_code &ec); // used to be wait push
bool try_push(const T& x, error_code &ec);

void push(T&& x);
bool push(T&& x, error_code &ec); // used to be wait push
bool try_push(T&& x, error_code &ec);
```

Finally to support async push and pop, we added

```c++
sender auto async_push(T x) noexcept(is_nothrow_move_constructible_v<T>);
sender auto async_pop() noexcept;
```

Note that async versions do not have `const T&` and `T&&` flavors,
since the handling ot the value may occur later on a different thread
the move of the value is required.

## Implementation experience

A demonstration implementation is available in https://github/GorNishanov/conqueue.

## References
